name: Magazyn360 CI/CD -- MAIN workflow 🦁
run-name: ${{ github.event.head_commit.message }} -- ${{ github.actor}} 🦁

on:
  push:
    branches: ["actions"]

jobs:
  lint:
    name: Lint with Ruff and Black
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Poetry
        run: pip install poetry==1.8.5

      - name: Install dependencies for linting
        working-directory: magazyn360-api
        run: poetry install --only dev

      - name: Run Ruff
        working-directory: magazyn360-api
        run: poetry run ruff check .

      - name: Run Black (check only)
        working-directory: magazyn360-api
        run: poetry run black --check .

  tests:
    name: Run Tests in Docker with Postgres
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: magazyn360
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name:  Build Docker image for tests
        run: docker build -t magazyn360 -f ./magazyn360-api/Dockerfile ./magazyn360-api

      - name: Launch Docker container
        run: |
          docker run --rm \
            -e SECRET_KEY=testsecret \
            -e DEBUG=False \
            -e POSTGRES_DB=magazyn360 \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=password \
            -e POSTGRES_HOST=host.docker.internal \
            -e POSTGRES_PORT=5432 \
            -v ${{ github.workspace }}/coverage:/usr/src/app/coverage \
            magazyn360

      - name: Check if container is running
        run: |
          docker ps

      - name: Run tests with coverage
        run: |
          docker exec magazyn360 /bin/bash -c "source /var/www/magazyn360/app/magazyn360_env/bin/activate && \
          /var/www/magazyn360/app/magazyn360_api/bin/run_tests.sh"
